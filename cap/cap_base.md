# CAP-теорема — базовый конспект

## 1. Что такое CAP-теорема

**CAP-теорема** утверждает:

> В распределённой системе невозможно одновременно гарантировать
> **Consistency**, **Availability** и **Partition tolerance**.

Можно выбрать **только два из трёх**.

---

## 2. Расшифровка CAP

### C — Consistency (согласованность)

Все клиенты системы видят **одни и те же данные** после записи.

Пример:
- Записали `balance = 100`
- Любой следующий `read` вернёт `100`

Характерно для:
- банковских систем
- леджеров
- строгих инвариантов

---

### A — Availability (доступность)

Каждый запрос получает ответ.

Даже если:
- часть серверов недоступна
- данные могут быть устаревшими

Главное — система **не молчит**.

Характерно для:
- соцсетей
- лент новостей
- счётчиков и метрик

---

### P — Partition tolerance (устойчивость к разделению сети)

Система продолжает работать, даже если:
- узлы не видят друг друга
- сеть между датацентрами разорвана

Важно:
- сетевые сбои **неизбежны**
- в реальных распределённых системах **P всегда присутствует**

---

## 3. Почему нельзя иметь C + A + P одновременно

Сценарий:
- Есть два сервера
- Между ними пропала сеть (partition)

Приходит запрос на запись.

### Вариант 1 — выбрать Consistency
- Сервер отказывается принимать запись
- Клиент получает ошибку

Результат:
- ✔️ C
- ✔️ P
- ❌ A

---

### Вариант 2 — выбрать Availability
- Сервер принимает запись локально
- Другой сервер обновится позже

Результат:
- ✔️ A
- ✔️ P
- ❌ C

---

## 4. Реальный мир и выбор

Так как **P неизбежен**, практический выбор всегда между:

- **CP** — согласованность важнее доступности
- **AP** — доступность важнее согласованности

---

## 5. Примеры CAP-моделей

### CP-системы

Поведение:
- лучше отказать, чем вернуть неверные данные

Примеры:
- транзакционные БД
- системы блокировок и координаторы

---

### AP-системы

Поведение:
- лучше ответить, даже если данные не совсем актуальны

Примеры:
- распределённые кеши
- системы логирования
- аналитика

---

## 6. Важные уточнения

- CAP **не про latency**
- CAP **не про single-node БД**
- CAP **не выбор "навсегда"**

CAP описывает **поведение системы при сетевых сбоях**.

---

## 7. Интуитивная метафора

Телефонный разговор:
- C — собеседник всегда говорит правду
- A — собеседник всегда отвечает
- P — связь может пропасть

Если связь пропала:
- либо он молчит, но не врёт
- либо отвечает, но может наврать

---

## 8. Краткий итог

- CAP — фундамент распределённых систем
- максимум 2 свойства из 3
- в реальности всегда выбирают между C и A
- архитектура важнее конкретной технологии

> CAP — это не теория про базы данных, а про честные компромиссы.