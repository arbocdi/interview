# 2PC (Two-Phase Commit) — конспект

## 1. Что такое 2PC

**2PC (Two-Phase Commit)** — это протокол распределённой транзакции, цель которого:

> Либо зафиксировать изменения **во всех участниках**, либо **откатить их везде**.

Используется, когда одна логическая операция затрагивает **несколько баз данных / шардов / сервисов**.

---

## 2. Участники протокола

- **Coordinator** — координатор транзакции (приложение или middleware)
- **Participants** — участники (БД, шарды, сервисы)

Coordinator управляет процессом, участники подчиняются его решениям.

---

## 3. Две фазы 2PC

### Фаза 1 — Prepare (голосование)

Coordinator отправляет всем участникам запрос:

> «Ты готов зафиксировать изменения?»

Каждый participant:
- проверяет ограничения и инварианты
- записывает изменения в журнал (WAL)
- **блокирует ресурсы**
- отвечает:
  - **YES** — готов к коммиту
  - **NO** — не готов

❗ В этот момент **коммита ещё нет** — участник лишь обещает, что сможет его выполнить.

---

### Фаза 2 — Commit / Rollback

#### Если ВСЕ ответили YES
Coordinator отправляет:

> `COMMIT`

Участники:
- фиксируют изменения
- снимают блокировки

---

#### Если ХОТЯ БЫ ОДИН ответил NO
Coordinator отправляет:

> `ROLLBACK`

Участники:
- откатывают изменения
- снимают блокировки

---

## 4. CAP-характеристики 2PC

2PC реализует модель **CP**:

- ✔️ **Consistency** — либо все закоммитились, либо никто
- ✔️ **Partition tolerance** — протокол учитывает сетевые сбои
- ❌ **Availability** — система может зависнуть и не отвечать

---

## 5. Основные проблемы 2PC

### 5.1 Падение Coordinator

Самый опасный сценарий:

1. Все участники ответили YES
2. Coordinator умер между фазами
3. Участники не знают, коммит был или нет
4. Транзакции остаются в состоянии `PREPARED`
5. Ресурсы и блокировки удерживаются

Результат:
- зависшие транзакции
- падение throughput
- необходимость ручного вмешательства

---

### 5.2 Долгие блокировки

- блокировки держатся дольше обычного
- растёт latency
- возможен cascade failure

---

### 5.3 Сетевые проблемы

- Prepare прошёл
- Commit не дошёл
- участники ждут неопределённо долго

---

## 6. 2PC в PostgreSQL

Пример:

```sql
PREPARE TRANSACTION 'tx1';
COMMIT PREPARED 'tx1';
```

Особенности:
- `PREPARED`-транзакции сохраняются при рестарте
- при сбоях требуют ручной очистки
- нужен мониторинг и дисциплина

---

## 7. Почему 2PC считают антипаттерном

- плохо масштабируется
- убивает availability
- сложно восстанавливать после сбоев
- требует высокой операционной зрелости

В микросервисах используется крайне редко.

---

## 8. Альтернативы 2PC

### Saga
- локальные транзакции
- компенсационные действия
- eventual consistency

### Outbox + Kafka
- атомарность внутри БД
- асинхронная доставка событий
- нет глобальных блокировок

### Event Sourcing
- нет распределённых транзакций
- вся согласованность через события

---

## 9. Краткий итог

- 2PC — попытка распространить ACID на несколько БД
- обеспечивает строгую согласованность
- цена — низкая доступность и сложность
- в большинстве случаев лучше архитектурные альтернативы

> 2PC — это «железная логика», которая плохо живёт в реальном распределённом мире.

