# Spring: —Å–µ—Ä–≤–∏—Å–Ω—ã–µ –ø—Ä–æ–∫—Å–∏ –∏ scope-–ø—Ä–æ–∫—Å–∏

–í Spring —Å–ª–æ–≤–æ **proxy** –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –¥–≤—É—Ö —Ä–∞–∑–Ω—ã—Ö —Å–º—ã—Å–ª–∞—Ö, –∏–∑-–∑–∞ —á–µ–≥–æ —á–∞—Å—Ç–æ –≤–æ–∑–Ω–∏–∫–∞–µ—Ç –ø—É—Ç–∞–Ω–∏—Ü–∞.
–ù–∏–∂–µ ‚Äî –∞–∫–∫—É—Ä–∞—Ç–Ω–æ–µ –∏ –ø—Ä–∞–∫—Ç–∏—á–Ω–æ–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ —Å ASCII‚Äë—Å—Ö–µ–º–∞–º–∏.

---

## 1. AOP / —Å–µ—Ä–≤–∏—Å–Ω—ã–µ –ø—Ä–æ–∫—Å–∏

–≠—Ç–æ –ø—Ä–æ–∫—Å–∏, –∫–æ—Ç–æ—Ä—ã–µ Spring —Å–æ–∑–¥–∞—ë—Ç **–¥–ª—è –∞—Å–ø–µ–∫—Ç–æ–≤**.

### –ó–∞—á–µ–º
–ß—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–≤–µ–¥–µ–Ω–∏–µ *–≤–æ–∫—Ä—É–≥* –≤—ã–∑–æ–≤–∞ –º–µ—Ç–æ–¥–∞:

- `@Transactional`
- `@Async`
- `@Cacheable`
- `@Retryable`
- `@Aspect`

### –û–±—â–∞—è —Å—Ö–µ–º–∞

```
+--------+       +-------------+       +----------------+
| Client | ----> | AOP Proxy   | ----> | Target Bean   |
+--------+       +-------------+       +----------------+
                     |
                     | before / after / around
                     | (tx, retry, cache, async)
```

### –ß—Ç–æ —Ä–µ–∞–ª—å–Ω–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø—Ä–∏ –≤—ã–∑–æ–≤–µ –º–µ—Ç–æ–¥–∞

```
client.call()
   |
   v
[proxy]
   |
   |-- begin transaction
   |-- security check
   |-- retry logic
   v
[target.method()]
   |
   |-- commit / rollback
   v
 return result
```

### –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è
- **JDK Dynamic Proxy** ‚Äî –µ—Å–ª–∏ –±–∏–Ω —Ä–µ–∞–ª–∏–∑—É–µ—Ç –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å  
- **CGLIB** ‚Äî –µ—Å–ª–∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –Ω–µ—Ç –∏–ª–∏ –≤–∫–ª—é—á—ë–Ω `proxyTargetClass=true`

### –í–∞–∂–Ω—ã–π –Ω—é–∞–Ω—Å
‚ùó **Self‚Äëinvocation –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç**

```
this.a()  ---> proxy ---> target.a()
   |
   +--> this.b()   (–ú –ò –ú –û –ø—Ä–æ–∫—Å–∏)
```

```java
@Transactional
public void a() {
    b(); // –≤—ã–∑–æ–≤ –Ω–∞–ø—Ä—è–º—É—é, –∞—Å–ø–µ–∫—Ç–æ–≤ –Ω–µ—Ç
}

@Transactional
public void b() {}
```

---

## 2. Scope‚Äëproxy (–ø—Ä–æ–∫—Å–∏ –æ–±–ª–∞—Å—Ç–∏ –≤–∏–¥–∏–º–æ—Å—Ç–∏)

–≠—Ç–æ –ø—Ä–æ–∫—Å–∏ **–Ω–µ –¥–ª—è –∞—Å–ø–µ–∫—Ç–æ–≤**, –∞ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è **lifecycle –±–∏–Ω–æ–≤**.

### –ó–∞—á–µ–º
–ö–æ–≥–¥–∞ –±–∏–Ω —Å –∫–æ—Ä–æ—Ç–∫–∏–º scope –≤–Ω–µ–¥—Ä—è–µ—Ç—Å—è –≤ –±–∏–Ω —Å –¥–ª–∏–Ω–Ω—ã–º scope:

- `singleton ‚Üí request`
- `singleton ‚Üí session`
- `singleton ‚Üí prototype`

### –ü—Ä–æ–±–ª–µ–º–∞ –±–µ–∑ –ø—Ä–æ–∫—Å–∏

```
Application start
   |
   v
create singleton Service
   |
   +--> create RequestBean  ‚ùå (–∑–∞–ø—Ä–æ—Å–∞ –µ—â—ë –Ω–µ—Ç)
```

```java
@Component
class Service {
    @Autowired
    RequestBean requestBean;
}
```

---

### –†–µ—à–µ–Ω–∏–µ ‚Äî scope‚Äëproxy
–ï—Å–ª–∏ scoped-–±–∏–Ω –≤–Ω–µ–¥—Ä—è–µ—Ç—Å—è –≤ –±–∏–Ω —Å –±–æ–ª–µ–µ —à–∏—Ä–æ–∫–∏–º scope (–Ω–∞–ø—Ä–∏–º–µ—Ä request ‚Üí singleton), Spring –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞—ë—Ç 
scoped-proxy, –¥–∞–∂–µ –µ—Å–ª–∏ proxyMode —è–≤–Ω–æ –Ω–µ —É–∫–∞–∑–∞–Ω.

```java
@Scope(value = "request", proxyMode = ScopedProxyMode.TARGET_CLASS)
@Component
class RequestBean {}
```

### –°—Ö–µ–º–∞ —Å–æ scope‚Äëproxy

```
+-----------+
| Service   |   singleton
+-----------+
      |
      v
+------------------+
| Scope Proxy      |  <-- –æ–¥–∏–Ω –∏ —Ç–æ—Ç –∂–µ
+------------------+
      |
      v
+------------------+
| RequestBean      |  <-- —Ä–∞–∑–Ω—ã–π
| (request #123)   |
+------------------+
```

### –ü—Ä–∏ –¥—Ä—É–≥–æ–º HTTP‚Äë–∑–∞–ø—Ä–æ—Å–µ

```
+------------------+
| Scope Proxy      |  <-- —Ç–æ—Ç –∂–µ —Å–∞–º—ã–π –æ–±—ä–µ–∫—Ç
+------------------+
      |
      v
+------------------+
| RequestBean      |
| (request #456)   |
+------------------+
```

üëâ Scope‚Äë–ø—Ä–æ–∫—Å–∏ **–∫–∞–∂–¥—ã–π –≤—ã–∑–æ–≤ –º–µ—Ç–æ–¥–∞** –∏—â–µ—Ç –∞–∫—Ç—É–∞–ª—å–Ω—ã–π –±–∏–Ω –≤ —Ç–µ–∫—É—â–µ–º scope.

---

## 2.1 ScopedProxyMode ‚Äî —á—Ç–æ —ç—Ç–æ –∏ –∑–∞—á–µ–º

`ScopedProxyMode` —É–ø—Ä–∞–≤–ª—è–µ—Ç **–∫–∞–∫ –∏–º–µ–Ω–Ω–æ Spring —Å–æ–∑–¥–∞—ë—Ç scope‚Äë–ø—Ä–æ–∫—Å–∏**.

---

### üîπ `ScopedProxyMode.NO` (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)

```
Service --> RequestBean (—Ä–µ–∞–ª—å–Ω—ã–π –æ–±—ä–µ–∫—Ç)
```

- –ü—Ä–æ–∫—Å–∏ **–Ω–µ —Å–æ–∑–¥–∞—ë—Ç—Å—è**
- —Ä–∞–±–æ—Ç–∞–µ—Ç, –∫–æ–≥–¥–∞ scope –≤–Ω–µ–¥—Ä—è–µ–º–æ–≥–æ –±–∏–Ω–∞ –Ω–µ —É–∂–µ‚Äù, —á–µ–º scope –±–∏–Ω–∞-–ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—è:
```java
scope(consumer) ‚äÜ scope(dependency)
```
- –ú–æ–∂–Ω–æ –≤–Ω–µ–¥—Ä–∏—Ç—å —á–µ—Ä–µ–∑ ObjectProvider<MyBean>

```java
@Scope("request")
```

---

### üîπ `ScopedProxyMode.INTERFACES`

```
Service
   |
   v
[JDK Proxy implements Interface]
   |
   v
Real Bean
```

```java
@Scope(value = "request", proxyMode = ScopedProxyMode.INTERFACES)
```

- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è **JDK Dynamic Proxy**
- –ü—Ä–æ–∫—Å–∏ —Ä–µ–∞–ª–∏–∑—É–µ—Ç **–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã**
- –ë–µ–∑ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ ‚Äî ‚ùå –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç

---

### üîπ `ScopedProxyMode.TARGET_CLASS`

```
Service
   |
   v
[CGLIB subclass of Bean]
   |
   v
Real Bean
```

```java
@Scope(value = "request", proxyMode = ScopedProxyMode.TARGET_CLASS)
```

- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è **CGLIB**
- –ü—Ä–æ–∫—Å–∏ ‚Äî –Ω–∞—Å–ª–µ–¥–Ω–∏–∫ –∫–ª–∞—Å—Å–∞
- –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å –Ω–µ –Ω—É–∂–µ–Ω

‚ö†Ô∏è –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è:
- `final` –∫–ª–∞—Å—Å—ã –∏ –º–µ—Ç–æ–¥—ã –Ω–µ –ø—Ä–æ–∫—Å–∏—Ä—É—é—Ç—Å—è

### –†–µ—à–µ–Ω–∏–µ 2 - ObjectProvider<MyBean>
- ObjectProvider<MyBean> –ø—Ä–∏ –≤—ã–∑–æ–≤–µ get() –ø–æ–∏—â–µ—Ç –±–∏–Ω –≤ –Ω—É–∂–Ω–æ–º —Å–∫–æ—É–ø–µ.

---
## 3. Lazy Proxy
- –°–æ–∑–¥–∞–µ—Ç—Å—è, –µ—Å–ª–∏ —Å–∏–Ω–≥–ª—Ç–æ–Ω –∞–Ω–Ω—Ç–æ—Ä–∏—Ä–æ–≤–∞–Ω @Lazy.
- –°–∞–º –±–∏–Ω –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –≤—ã–∑–æ–≤–µ –µ–≥–æ –º–µ—Ç–æ–¥–∞.
- –≠—Ç–æ lazy-init proxy, —Å–æ–∑–¥–∞–≤–∞–µ–º–∞—è ContextAnnotationAutowireCandidateResolver

–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏:
```
–µ—Å–ª–∏ –µ—Å—Ç—å –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å ‚Üí JDK dynamic proxy

–µ—Å–ª–∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –Ω–µ—Ç ‚Üí CGLIB proxy
```

## 4. –ì–ª–∞–≤–Ω–æ–µ —Ä–∞–∑–ª–∏—á–∏–µ AOP‚Äë–ø—Ä–æ–∫—Å–∏ –∏ scope‚Äë–ø—Ä–æ–∫—Å–∏

```
AOP proxy:
client -> proxy -> target
             ^
             |
        –ø–æ–≤–µ–¥–µ–Ω–∏–µ

Scope proxy:
client -> proxy -> (lookup target in scope)
```

| –ö—Ä–∏—Ç–µ—Ä–∏–π | AOP‚Äë–ø—Ä–æ–∫—Å–∏ | Scope‚Äë–ø—Ä–æ–∫—Å–∏ |
|--------|-----------|-------------|
| –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ | –ü–æ–≤–µ–¥–µ–Ω–∏–µ | –≠–∫–∑–µ–º–ø–ª—è—Ä |
| –ú–µ–Ω—è–µ—Ç –ª–æ–≥–∏–∫—É | ‚úÖ | ‚ùå |
| `@Transactional` | ‚úÖ | ‚ùå |
| `@Scope` | ‚ùå | ‚úÖ |

---

## 5. –î–≤–æ–π–Ω—ã–µ –ø—Ä–æ–∫—Å–∏ (–æ–ø–∞—Å–Ω–∞—è –∑–æ–Ω–∞)

```java
@RequestScope
@Transactional
@Service
class MyService {}
```

–í–æ–∑–º–æ–∂–Ω–∞—è —Ä–µ–∞–ª—å–Ω–∞—è —Ü–µ–ø–æ—á–∫–∞:

```
Client
  |
  v
AOP Proxy (@Transactional)
  |
  v
Scope Proxy (@RequestScope)
  |
  v
Real MyService
```

–ß–∞—Å—Ç—ã–µ —Å–∏–º–ø—Ç–æ–º—ã:
- —Å–ª–æ–∂–Ω–æ –¥–µ–±–∞–∂–∏—Ç—å
- `ClassCastException`
- –Ω–µ–ø–æ–Ω—è—Ç–Ω–æ, –ø–æ—á–µ–º—É –∞—Å–ø–µ–∫—Ç ¬´–Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª¬ª

---

## 6. –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–∞–≤–∏–ª–∞

- `@Transactional`, `@Async`, `@Retryable` ‚Üí **AOP‚Äë–ø—Ä–æ–∫—Å–∏**
- `@RequestScope`, `@SessionScope`, `prototype` ‚Üí **scope‚Äë–ø—Ä–æ–∫—Å–∏**
- `proxyMode = ScopedProxyMode...` ‚Üí –≤—Å–µ–≥–¥–∞ **scope**
- `@EnableAspectJAutoProxy` ‚Üí –≤—Å–µ–≥–¥–∞ **AOP**

---

## 7. –ö–æ—Ä–æ—Ç–∫–∞—è –ø–∞–º—è—Ç–∫–∞

```
AOP‚Äëproxy    = –¥–æ–±–∞–≤–ª—è–µ—Ç –ø–æ–≤–µ–¥–µ–Ω–∏–µ
Scope‚Äëproxy  = –ø–æ–¥–±–∏—Ä–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ–±—ä–µ–∫—Ç
```
