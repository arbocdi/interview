# HTTP методы и идемпотентность

## Идемпотентность
**Идемпотентный метод** — повторный вызов даёт тот же эффект на сервере, что и один вызов.

### Идемпотентные
- **GET** — получить ресурс (safe)
- **HEAD** — метаданные (safe)
- **OPTIONS** — возможности (safe)
- **TRACE** — диагностика (safe)
- **PUT** — установить ресурс в заданное состояние (или создать по id)
- **DELETE** — удалить ресурс (логически идемпотентен)

### Не идемпотентные
- **POST** — обычно создаёт новую операцию/ресурс (сервер генерирует id)
- **PATCH** — частичное изменение (обычно не идемпотентен)

### Когда PATCH идемпотентен
PATCH может быть идемпотентным, если патч описывает целевое состояние, а не действие.
❌ Неидемпотентный PATCH (самый частый)
```http request
PATCH /account/1
{ "balanceDelta": -100 }
```

Повтор:
-1 раз → -100
-2 раза → -200

> Safe ≠ идемпотентный: PUT и DELETE идемпотентны, но имеют побочные эффекты.

---

## Классическое REST API (CRUD)

- **GET /resources** — список
- **GET /resources/{id}** — получить
- **POST /resources** — создать (id выдаёт сервер)
- **PUT /resources/{id}** — полностью заменить / upsert/создать
- **PATCH /resources/{id}** — частично изменить
- **DELETE /resources/{id}** — удалить

### Практика
- Клиент генерирует id → **PUT** (идемпотентно)
- Сервер генерирует id → **POST**
- Частичный апдейт → **PATCH**

---

## API агрегатов (DDD / CQRS, всё через команды)

### Команды
- **POST /aggregates/{id}/commands/{commandName}**
- Тело: параметры команды
- Обязательно: **commandId / Idempotency-Key**
- Ответы: `200 OK` (синхронно) или `202 Accepted` (асинхронно)

Примеры:
- `POST /accounts/{id}/commands/withdraw`
- `POST /orders/{id}/commands/approve`

Идемпотентность достигается **дедупликацией команд**, а не HTTP-методом.

### Чтение (queries)
- **GET** к read-model:
  - `GET /accounts/{id}`
  - `GET /orders?status=NEW`

### Когда уместен PUT в командной модели
- Команда моделируется как ресурс с известным id:
  - `PUT /commands/{commandId}`
  - `PUT /transfers/{transferId}`

Подходит для:
- создания операции с клиентским id
- set-state команд

---

## Краткая шпаргалка

- CRUD REST → **GET / POST / PUT / PATCH / DELETE**
- DDD команды → **POST + idempotency key**
- Идемпотентность команд → **inbox / commandId**, а не PUT

